<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Progress Tree + Structures</title>

<!-- DataTables CSS -->
<link rel="stylesheet" href="libs/jquery.dataTables.min.css">
<link rel="stylesheet" href="libs/fixedHeader.dataTables.min.css">

<style>
body {
  font-family: Arial, sans-serif;
  background-color: #222;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 20px;
}

/* Tree Grid */
.container {
  display: grid;
  grid-template-columns: repeat(6, 200px);
  grid-template-rows: repeat(13, 19px);
  gap: 5px 20px;
  justify-content: center;
  margin: 20px auto;
  position: relative;
}
.section {
  background-color: #000;
  border: 1px solid #666;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  z-index: 1;
}
.section:hover { border-color: #ffcc00; }
.section.active { border-color: #4287f5; background-color: #111; }

svg#lines {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
}

/* Table Styles */
#topNav { margin-bottom: 15px; }
.nav-btn {
  margin: 2px;
  padding: 6px 12px;
  border: 1px solid #555;
  border-radius: 4px;
  background: #333;
  color: #fff;
  cursor: pointer;
}
.nav-btn:hover { background: #555; }
.nav-btn.active { background: #4287f5; border-color: #4287f5; }

#tableToggle { margin-top: 20px; }
.toggle-table-btn {
  margin: 2px;
  padding: 6px 12px;
  cursor: pointer;
  border: 1px solid #555;
  border-radius: 4px;
  background: #eee;
  color: #000;
}
.toggle-table-btn.active {
  background: #4287f5;
  color: #fff;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  color: black;
  margin-top: 10px;
}

table th, table td {
  color: black;
  padding: 4px 6px;
  white-space: nowrap;
}
table.dataTable tbody tr.odd {
  background-color: #e6e6e6; 
}
table.dataTable tbody tr.even {
  background-color: #ffffff;
}
</style>
</head>
<body>

<!-- Navigation -->
<div id="topNav">
  <button class="nav-btn" data-page="Research.html">Research</button>
  <button class="nav-btn" data-page="index.html">Structures</button>
  <button class="nav-btn" data-page="units.html">Units</button>
</div>

<!-- Tree -->
<div class="container" id="mapContainer">
  <div class="section root" data-key="Headquarters" style="grid-row:1 / span 12; grid-column:1;">Headquarters</div>
  <div class="section" data-key="Outpost Strategic" style="grid-row:13; grid-column:1;">Outpost Strategic</div>

  <div class="section" data-key="Bunker" style="grid-row:1; grid-column:2;">Bunker</div>
  <div class="section" data-key="Black Market" style="grid-row:2 / span 3; grid-column:2;">Black Market</div>
  <div class="section" data-key="Geoponic Farm" style="grid-row:5 / span 2; grid-column:2;">Geoponic Farm</div>
  <div class="section" data-key="Oil Rig" style="grid-row:7 / span 2; grid-column:2;">Oil Rig</div>
  <div class="section" data-key="Alloy Refinery" style="grid-row:9 / span 2; grid-column:2;">Alloy Refinery</div>
  <div class="section" data-key="Supply Depot" style="grid-row:11; grid-column:2;">Supply Depot</div>
  <div class="section" data-key="Situation Room" style="grid-row:12; grid-column:2;">Situation Room</div>
  <div class="section" data-key="Outpost Harvest" style="grid-row:13; grid-column:2;">Outpost Harvest</div>

  <div class="section" data-key="Engineering" style="grid-row:2 / span 3; grid-column:3;">Engineering</div>
  <div class="section" data-key="Barracks" style="grid-row:5 / span 2; grid-column:3;">Barracks</div>
  <div class="section" data-key="Research Lab" style="grid-row:7 / span 2; grid-column:3;">Research Lab</div>
  <div class="section" data-key="Wall" style="grid-row:9 / span 2; grid-column:3;">Wall</div>
  <div class="section" data-key="Global Network" style="grid-row:11; grid-column:3;">Global Network</div>

  <div class="section" data-key="Experimentation Chamber" style="grid-row:2; grid-column:4;">Experimentation Chamber</div>
  <div class="section" data-key="Factory" style="grid-row:3; grid-column:4;">Factory</div>
  <div class="section" data-key="Turret" style="grid-row:4; grid-column:4;">Turret</div>
  <div class="section" data-key="Medical Bay" style="grid-row:5; grid-column:4;">Medical Bay</div>
  <div class="section" data-key="Command Post" style="grid-row:6; grid-column:4;">Command Post</div>
  <div class="section" data-key="Hostile Containment" style="grid-row:7; grid-column:4;">Hostile Containment</div>
  <div class="section" data-key="Shard Reactor" style="grid-row:8; grid-column:4;">Shard Reactor</div>
  <div class="section" data-key="Airstrip" style="grid-row:9; grid-column:4;">Airstrip</div>
  <div class="section" data-key="Satellite Uplink" style="grid-row:10; grid-column:4;">Satellite Uplink</div>
  <div class="section" data-key="Security Station" style="grid-row:11; grid-column:4;">Security Station</div>

  <div class="section" data-key="Robotics Bay" style="grid-row:3; grid-column:5;">Robotics Bay</div>
  <div class="section" data-key="Hero Armory" style="grid-row:6; grid-column:5;">Hero Armory</div>
  <div class="section" data-key="Alien Genetics Labs" style="grid-row:7; grid-column:5;">Alien Genetics Labs</div>

  <svg id="lines"></svg>
</div>

<!-- Table Toggle -->
<div id="tableToggle">
  <button class="toggle-table-btn active" data-table="costs">Costs</button>
  <button class="toggle-table-btn" data-table="rewards">Rewards</button>
  <button class="toggle-table-btn" data-table="stats">Stats</button>
</div>

<!-- Tables -->
<div id="costsWrapper">
  <table id="costsTable"></table>
</div>
<div id="rewardsWrapper" style="height:0; overflow:hidden;">
  <table id="rewardsTable"></table>
</div>
<div id="statsWrapper" style="height:0; overflow:hidden;">
  <table id="statsTable"></table>
</div>

<!-- Scripts -->
<script src="libs/jquery-3.7.0.min.js"></script>
<script src="libs/jquery.dataTables.min.js"></script>
<script src="libs/dataTables.fixedHeader.min.js"></script>

<script>
$(document).ready(function(){

    // --- Page navigation ---
    $('#topNav .nav-btn').each(function(){
        if ($(this).data('page') === window.location.pathname.split('/').pop()) $(this).addClass('active');
        $(this).on('click', function(){ window.location.href = $(this).data('page'); });
    });

    // --- Helper: format seconds into d/h/m/s ---
    function formatTime(seconds) {
        if (seconds === "-" || seconds === undefined || seconds === null) return "-";
        seconds = Number(seconds) || 0;
        if (seconds <= 0) return "-";
        const d = Math.floor(seconds / 86400); seconds %= 86400;
        const h = Math.floor(seconds / 3600); seconds %= 3600;
        const m = Math.floor(seconds / 60); const s = seconds % 60;
        const parts = [];
        if (d) parts.push(d + "d");
        if (h) parts.push(h + "h");
        if (m) parts.push(m + "m");
        if (s) parts.push(s + "s");
        return parts.join(" ");
    }

    // --- Tables ---
    // NOTE: last column is a hidden column that stores raw seconds (so indexing of visible cols stays the same)
    const costsTable = $('#costsTable').DataTable({
        scrollY: "800px",
        scrollCollapse: true,
        paging: false,
        dom: 'ti',
        info: false,
        fixedHeader: true,
        ordering: false, // remove sorting arrows
        columns:[
            { title:"Key", visible:false },
            { title:"Level" },
            // put input in title without setting a static value (we'll manage value separately)
            { title: 'Time <input type="number" class="time-scale" style="width:60px;"> %' },
            { title:"Tech" },
            { title:"Food" },
            { title:"Oil" },
            { title:"Alloy" },
            { title:"Neutronium" },
            { title:"Alliance Credits" },
            { title:"Neutronium Crystal" },
            { title:"Classified Docs" },
            { title:"Data Disk" },
            { title:"Alien Power Core" },
            { title:"Alien Tech" },
            { title:"Alien Armor" },
            { title:"Armory Blueprints" },
            { title:"_raw", visible:false } // <-- hidden raw seconds column
        ]
    });

    const rewardsTable = $('#rewardsTable').DataTable({
        scrollY: "800px", scrollCollapse: true, paging: false, dom: 'ti', info: false, fixedHeader: true, ordering:false,
        columns:[
            { title:"Key", visible:false },
            { title:"Level" },
            { title:"Power" },
            { title:"Hero XP" }
        ]
    });

    const statsTable = $('#statsTable').DataTable({
        scrollY: "800px", scrollCollapse: true, paging: false, dom: 'ti', info: false, fixedHeader: true, ordering:false,
        columns:[
            { title:"Key", visible:false },
            { title:"Level" },
            { title:"Unit Capacity" }
        ]
    });

    // current scale (persisted while redraws happen)
    let currentScale = 0;

    // --- Apply scaling to all rows (uses hidden raw column at the end)
    function applyScale(scale) {
        // iterate every row and update the display cell (column index = 2)
        costsTable.rows().every(function(){
            const d = this.data(); // array
            const raw = Number(d[d.length - 1]); // last element is raw seconds
            if (raw > 0) {
                // formula: scaled = original / (1 + scale/100)
                const scaled = Math.floor(raw / (1 + scale/100));
                d[2] = formatTime(scaled);
            } else {
                d[2] = "-";
            }
            this.data(d);
        });
        costsTable.draw(false);
    }

    // delegate input events to both original header and floating clone (both have .time-scale)
    $(document).on('input', '.time-scale', function(){
        const v = $(this).val();
        const parsed = parseFloat(v);
        // don't set NaN, keep previous if user clears (so typing isn't aggressively overridden)
        if (!isNaN(parsed)) currentScale = parsed;
        // sync both inputs
        $('.time-scale').val(currentScale);
        // update table display (will trigger draw which will re-sync input in draw handler)
        applyScale(currentScale);
    });

    // Ensure after every draw we keep the input value in the header(s) AND redraw the tree lines
    costsTable.on('draw.dt', function(){
        $('.time-scale').val(currentScale); // resync header(s)
        // redraw lines so they reflect any layout changes
        try { drawLines(); } catch(e){ console.error('drawLines error', e); }
    });

    // --- Load JSON and populate tables ---
    const keyMap = {
        "Headquarters": "Headquarters",
        "Black Market": "Blackmarket",
        "Geoponic Farm": "Hydroponicfarm",
        "Oil Rig": "Oilrig",
        "Alloy Refinery": "Alloyrefinery",
        "Supply Depot": "Supplydepot",
        "Situation Room": "War_room",
        "Engineering": "Engineering",
        "Barracks": "Barracks",
        "Research Lab": "Researchlab",
        "Wall": "Walls",
        "Global Network": "Globalnetwork",
        "Experimentation Chamber": "Experimentation_chamber",
        "Factory": "Factory",
        "Turret": "Turret",
        "Medical Bay": "Medicalbay",
        "Hostile Containment": "Hostilecontainment",
        "Airstrip": "Airstrip",
        "Satellite Uplink": "Satelliteuplink",
        "Security Station": "Securitystation",
        "Robotics Bay": "Robotics_bay",
        "Command Post": "Commandpost",
        "Alien Genetics Labs": "Alien_genetics_lab",
        "Hero Armory": "Hero_armory",
        "Bunker": "Shelter",
        "Shard Reactor": "Shardcondenser",
        "Outpost Strategic": "Outpost_strategic",
        "Outpost Harvest": "Outpost_harvest"
    };

    fetch('molds/categories/structures.json')
    .then(r => r.json())
    .then(data => {
        const subtypes = data._subtypes || {};
        Object.entries(subtypes).forEach(([key, building]) => {
            let prevPower = 0;
            (building.levels || []).forEach((lvl, i) => {
                if (!Object.keys(lvl).length) return;
                const power = ((lvl.power ?? 0) - prevPower).toLocaleString(); prevPower = lvl.power ?? 0;
                const c3 = (lvl.costs?.find(c => c.target_subtype === 'currency3')?.quantity ?? 0).toLocaleString();
                const c4 = (lvl.costs?.find(c => c.target_subtype === 'currency4')?.quantity ?? 0).toLocaleString();
                const c5 = (lvl.costs?.find(c => c.target_subtype === 'currency5')?.quantity ?? 0).toLocaleString();
                const c6 = (lvl.costs?.find(c => c.target_subtype === 'currency6')?.quantity ?? 0).toLocaleString();
                const c7 = (lvl.costs?.find(c => c.target_subtype === 'currency7')?.quantity ?? 0).toLocaleString();
                const c8 = (lvl.costs?.find(c => c.target_subtype === 'currency8')?.quantity ?? 0).toLocaleString();
                const cnc = (lvl.costs?.find(c => c.target_subtype === 'core_neutronium_crystal')?.quantity ?? 0).toLocaleString();
                const ccd = (lvl.costs?.find(c => c.target_subtype === 'core_classified_documents')?.quantity ?? 0).toLocaleString();
                const cdd = (lvl.costs?.find(c => c.target_subtype === 'core_data_disk')?.quantity ?? 0).toLocaleString();
                const capc = (lvl.costs?.find(c => c.target_subtype === 'core_alien_power_core')?.quantity ?? 0).toLocaleString();
                const cac = (lvl.costs?.find(c => c.target_subtype === 'core_alien_component')?.quantity ?? 0).toLocaleString();
                const caa = (lvl.costs?.find(c => c.target_subtype === 'core_alien_armor')?.quantity ?? 0).toLocaleString();
                const ab = (lvl.costs?.find(c => c.target_subtype === 'armory_blueprints')?.quantity ?? 0).toLocaleString();
                const heroXP = (lvl.reward?.hero_xp ?? 0).toLocaleString();
                const unitCap = typeof lvl.unit_capacity === 'number' ? lvl.unit_capacity.toLocaleString() : "-";
                const rawTime = Number(lvl.upgrade_cost ?? 0);
                const timeStr = rawTime > 0 ? formatTime(Math.floor(rawTime / (1 + currentScale/100))) : "-";

                // Add row: last item is rawTime (hidden)
                costsTable.row.add([ key, i, timeStr, c3, c4, c5, c6, c7, c8, cnc, ccd, cdd, capc, cac, caa, ab, rawTime ]);
                rewardsTable.row.add([ key, i, power, heroXP ]);
                statsTable.row.add([ key, i, unitCap ]);
            });
        });

        // initial draw
        costsTable.draw();
        rewardsTable.draw();
        statsTable.draw();

        // ensure header input gets the current scale after initial draw
        $('.time-scale').val(currentScale);
        // ensure lines drawn after the page has layout
        setTimeout(drawLines, 50);
    })
    .catch(err => {
        console.error('Failed to load structures.json', err);
    });

    // --- Tree filter ---
    const columnMap = {
        "War_room": [9,10],
        "Commandpost": [9,11],
        "Engineering": [12],
        "Researchlab": [13],
        "Walls": [14],
        "Turret": [14],
        "Hero_armory": [15]
    };
    const timeHidden = ["Outpost_harvest","Outpost_strategic"];
    const outposts = ["Outpost_harvest","Outpost_strategic"];

    $('.section').on('click', function(){
        $('.section').removeClass('active');
        $(this).addClass('active');

        const jsonKey = keyMap[$(this).text().trim()] || $(this).text().trim();
        [costsTable, rewardsTable, statsTable].forEach(tbl => tbl.column(0).search(jsonKey, true, false).draw());

        // hide all conditional columns first
        costsTable.columns([2,8,9,10,11,12,13,14,15]).visible(false);

        // time column visible if not hidden
        if (!timeHidden.includes(jsonKey)) costsTable.column(2).visible(true);

        // show columns from mapping
        if (columnMap[jsonKey]) {
            columnMap[jsonKey].forEach(idx => costsTable.column(idx).visible(true));
        }

        // show CNC (index 9) for all non-Outposts
        if (!outposts.includes(jsonKey)) costsTable.column(9).visible(true);

        $('.time-scale').val(currentScale);
        setTimeout(drawLines, 20);
    });
    $('.section.root').trigger('click');

    // --- Table toggle buttons ---
    $('.toggle-table-btn').on('click', function() {
        $('.toggle-table-btn').removeClass('active'); $(this).addClass('active');
        const tbl = $(this).data('table');

        $('#costsWrapper, #rewardsWrapper, #statsWrapper').css({height:0, overflow:'hidden'});
        $(`#${tbl}Wrapper`).css({height:'auto', overflow:'visible'});

        // Force FixedHeader to recalc and draw lines
        try {
            costsTable.fixedHeader.adjust();
            rewardsTable.fixedHeader.adjust();
            statsTable.fixedHeader.adjust();
        } catch(e){ /* ignore */ }

        setTimeout(drawLines, 20);
    });

    // --- Draw tree lines ---
    function drawLines(){
        const svg = document.getElementById('lines');
        if (!svg) return;
        svg.innerHTML = '';
        const container = document.getElementById('mapContainer');
        if (!container) return;

        const treeMap = {
            "Headquarters": ["Bunker","Black Market","Geoponic Farm","Oil Rig","Alloy Refinery","Supply Depot","Situation Room"],
            "Bunker": [], "Black Market": ["Engineering"], "Engineering": ["Experimentation Chamber","Factory","Turret"],
            "Factory": ["Robotics Bay"], "Geoponic Farm": ["Barracks"], "Oil Rig": ["Research Lab"], "Alloy Refinery": ["Wall"],
            "Barracks": ["Medical Bay","Command Post"], "Research Lab": ["Hostile Containment","Shard Reactor"], "Medical Bay": [],
            "Hostile Containment": ["Alien Genetics Labs"], "Wall": ["Airstrip","Satellite Uplink"], "Command Post": ["Hero Armory"],
            "Robotics Bay": [], "Alien Genetics Labs": [], "Hero Armory": [], "Supply Depot": ["Global Network"], "Global Network": ["Security Station"],
            "Situation Room": [], "Airstrip": [], "Satellite Uplink": [], "Security Station": [], "Turret": [], "Experimentation Chamber": [],
            "Shard Reactor": [], "Outpost Harvest": [], "Outpost Strategic": []
        };

        const elems = Array.from(container.children)
            .filter(el => el.classList && el.classList.contains('section'))
            .reduce((acc, el) => { acc[el.innerText.trim()] = el; return acc; }, {});

        for(let parentName in treeMap){
            const children = treeMap[parentName];
            if(!children.length) continue;
            const parentEl = elems[parentName]; if(!parentEl) continue;
            const parentRect = parentEl.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            const startX = parentRect.right - containerRect.left;
            const startY = parentRect.top - containerRect.top + parentRect.height/2;

            children.forEach(childName => {
                const childEl = elems[childName]; if(!childEl) return;
                const childRect = childEl.getBoundingClientRect();
                const endX = childRect.left - containerRect.left;
                const endY = childRect.top - containerRect.top + childRect.height/2;
                const midX = startX + (endX - startX) / 2;

                const polyline = document.createElementNS("http://www.w3.org/2000/svg","polyline");
                polyline.setAttribute('points', `${startX},${startY} ${midX},${startY} ${midX},${endY} ${endX},${endY}`);
                polyline.setAttribute('stroke', '#ffcc00');
                polyline.setAttribute('stroke-width', '2');
                polyline.setAttribute('fill', 'none');
                polyline.setAttribute('stroke-linecap', 'round');
                polyline.setAttribute('stroke-linejoin', 'round');
                svg.appendChild(polyline);
            });
        }
    }

    // ensure lines redraw on resize
    window.addEventListener('resize', function(){ setTimeout(drawLines, 20); });

});
</script>

</body>
</html>
